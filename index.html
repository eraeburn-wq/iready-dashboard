<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>iReady Proficiency Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* { box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: #1e1e2f; color: #fff; margin: 0; padding: 0; }

header {
    padding: 25px;
    text-align: center;
    background: #27293d;
    font-size: 28px;
    font-weight: bold;
}

.loading-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: #aaa;
    font-size: 16px;
    gap: 16px;
}
.spinner {
    width: 40px; height: 40px;
    border: 4px solid #3a3a4f;
    border-top-color: #4c8bf5;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.tabs { display: flex; gap: 10px; padding: 8px 20px; flex-wrap: wrap; align-items: center; }
.tabs-label { color: #aaa; font-size: 13px; min-width: 70px; }
.tab { background: #2d2f40; padding: 8px 18px; border-radius: 6px; cursor: pointer; user-select: none; font-size: 14px; transition: background 0.2s; }
.tab.active { background: #4c8bf5; }
.tab:hover:not(.active) { background: #3a3d55; }

.filter-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 20px;
    flex-wrap: wrap;
    background: #27293d;
    margin-bottom: 4px;
}
.filter-bar label { color: #aaa; font-size: 13px; white-space: nowrap; }
.filter-bar select {
    background: #2d2f40;
    color: #fff;
    border: 1px solid #4c8bf5;
    border-radius: 6px;
    padding: 7px 14px;
    font-size: 14px;
    cursor: pointer;
    min-width: 200px;
}

.card-container { display: flex; gap: 20px; padding: 20px; flex-wrap: wrap; }
.card { background: #2d2f40; padding: 20px; border-radius: 10px; flex: 1; min-width: 180px; }
.card h3 { margin-top: 0; font-size: 12px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; }
.big-num { font-size: 32px; font-weight: bold; color: #fff; margin-top: 4px; }

.chart-box { background: #2d2f40; margin: 20px; padding: 20px; border-radius: 10px; }
.chart-box h3 { margin-top: 0; font-size: 15px; color: #ccc; border-bottom: 1px solid #3a3a4f; padding-bottom: 10px; margin-bottom: 16px; }

table { width: 100%; border-collapse: collapse; }
th, td { padding: 11px 12px; border-bottom: 1px solid #3a3a4f; text-align: left; font-size: 14px; }
th { color: #4c8bf5; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
tr:hover td { background: #33364f; }

.pct-bar-wrap { display: flex; align-items: center; gap: 8px; }
.pct-bar-bg { flex: 1; background: #3a3a55; border-radius: 4px; height: 8px; overflow: hidden; min-width: 60px; }
.pct-bar-fill { height: 8px; border-radius: 4px; background: #4c8bf5; }

hr.divider { border: none; border-top: 1px solid #3a3a4f; margin: 4px 20px; }
.empty-state { padding: 30px 20px; color: #aaa; font-size: 15px; line-height: 1.8; }

.config-banner {
    background: #2d2f40;
    border: 2px dashed #4c8bf5;
    border-radius: 10px;
    margin: 20px;
    padding: 24px;
    font-size: 14px;
    line-height: 1.9;
    color: #ccc;
}
.config-banner h2 { margin-top: 0; color: #4c8bf5; }
.config-banner code { background: #1e1e2f; padding: 2px 8px; border-radius: 4px; font-size: 13px; color: #fff; }
.config-banner ol { padding-left: 20px; }
.config-banner li { margin-bottom: 8px; }

.last-updated { text-align: right; padding: 6px 24px 0; font-size: 12px; color: #555; }

.subgroup-tag {
    display: inline-block;
    background: #4c8bf5;
    color: #fff;
    font-size: 12px;
    padding: 3px 10px;
    border-radius: 20px;
    margin-left: 10px;
    vertical-align: middle;
}
</style>
</head>
<body>

<header>üìä iReady Projected Proficiency Dashboard</header>

<!-- SETUP INSTRUCTIONS -->
<div class="config-banner" id="setupBanner" style="display:none;">
    <h2>üõ†Ô∏è One-Time Setup Required</h2>
    <p>This dashboard reads live student-level data from a Google Sheet. Follow these steps:</p>
    <ol>
        <li>
            <strong>Create your Google Sheet</strong> with these 4 tab names (exact spelling):<br>
            <code>ELA Fall</code> &nbsp; <code>ELA Winter</code> &nbsp; <code>Math Fall</code> &nbsp; <code>Math Winter</code>
        </li>
        <li>
            <strong>Paste your iReady student-level CSV data</strong> into each tab ‚Äî one row per student.<br>
            Required columns: <code>School</code>, <code>Student Grade</code>, <code>Sex</code>, <code>Combined Race and Ethnicity</code>,
            <code>English Language Learner</code>, <code>Special Education</code>, <code>Economically Disadvantaged</code>,
            <code>504 Eligible</code>, <code>Proficiency if Student Shows No Additional Growth</code>
        </li>
        <li><strong>Share the Sheet:</strong> Click <em>Share ‚Üí Anyone with the link ‚Üí Viewer</em>.</li>
        <li>
            <strong>Copy your Sheet ID</strong> from the URL:<br>
            <code>https://docs.google.com/spreadsheets/d/<strong>YOUR_ID_HERE</strong>/edit</code>
        </li>
        <li>
            Open this HTML file in Notepad, find:<br>
            <code>const SHEET_ID = "1ctBefvTlb4YtisW2a2NB7HHy6_m20d54Y2HPe9YayWY";</code><br>
            Replace with your actual Sheet ID and save.
        </li>
        <li>Upload to GitHub Pages for a permanent shareable link.</li>
    </ol>
</div>

<!-- DASHBOARD -->
<div id="dashboardUI" style="display:none;">
    <div class="last-updated" id="lastUpdated"></div>

    <!-- SUBJECT + TERM TABS -->
    <div class="tabs" id="subjectTabs">
        <span class="tabs-label">Subject:</span>
        <div class="tab active" onclick="selectSubject('ELA')">Reading (ELA)</div>
        <div class="tab" onclick="selectSubject('Math')">Math</div>
    </div>

    <div class="tabs" id="termTabs">
        <span class="tabs-label">Term:</span>
        <div class="tab active" onclick="selectTerm('Fall')">Fall</div>
        <div class="tab" onclick="selectTerm('Winter')">Winter</div>
    </div>

    <div class="tabs" id="viewTabs">
        <span class="tabs-label">View:</span>
        <div class="tab active" onclick="selectView('School')">School</div>
        <div class="tab" onclick="selectView('Grade')">Grade</div>
        <div class="tab" onclick="selectView('SchoolGrade')">School+Grade</div>
        <div class="tab" onclick="selectView('District')">District</div>
        <div class="tab" onclick="selectView('Bands')">Bands</div>
        <div class="tab" onclick="selectView('Subgroups')">All Subgroups</div>
    </div>

    <!-- SUBGROUP FILTER ‚Äî always visible -->
    <div class="filter-bar">
        <label>üîç Filter by Subgroup:</label>
        <select id="subgroupFilter" onchange="renderDashboard()">
            <option value="ALL">All Students</option>
            <optgroup label="Sex">
                <option value="SEX:male">Male</option>
                <option value="SEX:female">Female</option>
            </optgroup>
            <optgroup label="Race / Ethnicity">
                <option value="RACE:White (non-Hispanic)">White</option>
                <option value="RACE:Black or African American (non-Hispanic)">Black or African American</option>
                <option value="RACE:Hispanic or Latino (of any race)">Hispanic or Latino</option>
                <option value="RACE:Asian">Asian</option>
                <option value="RACE:Two or more Races">Two or More Races</option>
                <option value="RACE:American Indian or Alaska Native">American Indian or Alaska Native</option>
            </optgroup>
            <optgroup label="Student Groups">
                <option value="ESS:Y">ESS (Special Education)</option>
                <option value="ELL:Y">ELL (English Language Learner)</option>
                <option value="ED:Y">Economically Disadvantaged</option>
                <option value="504:true">504</option>
            </optgroup>
        </select>

        <label style="margin-left:20px;">Filter by School:</label>
        <select id="schoolFilter" onchange="renderDashboard()">
            <option value="ALL">All Schools</option>
        </select>
    </div>

    <hr class="divider">
    <div id="dashboardContent"></div>
</div>

<div class="loading-screen" id="loadingScreen" style="display:none;">
    <div class="spinner"></div>
    <div id="loadingMsg">Loading data...</div>
</div>

<script>
// ============================================================
// ‚úèÔ∏è  CONFIGURATION
// ============================================================
const SHEET_ID = "1ctBefvTlb4YtisW2a2NB7HHy6_m20d54Y2HPe9YayWY";

const TABS = [
    ["ELA",  "Fall",   "ELA Fall"],
    ["ELA",  "Winter", "ELA Winter"],
    ["Math", "Fall",   "Math Fall"],
    ["Math", "Winter", "Math Winter"],
];

// ============================================================
// STATE ‚Äî raw student rows
// ============================================================
let rawStore = {
    ELA:  { Fall: [], Winter: [] },
    Math: { Fall: [], Winter: [] }
};

let currentSubject = "ELA";
let currentTerm    = "Fall";
let currentView    = "School";

// ============================================================
// FETCH SHEET TAB
// ============================================================
async function fetchSheetTab(tabName) {
    const url  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(tabName)}`;
    const res  = await fetch(url);
    const text = await res.text();
    const json = JSON.parse(text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);/)[1]);
    const table = json.table;
    if (!table || !table.cols || !table.rows) return [];
    const headers = table.cols.map(c => c.label || c.id);
    return table.rows
        .filter(row => row.c && row.c.some(cell => cell && cell.v !== null))
        .map(row => {
            const obj = {};
            row.c.forEach((cell, i) => {
                if (!cell || cell.v === null || cell.v === undefined) {
                    obj[headers[i]] = "";
                } else {
                    // Use formatted value (f) if available, otherwise convert value (v) to string
                    obj[headers[i]] = String(cell.f !== undefined && cell.f !== null ? cell.f : cell.v).trim();
                }
            });
            return obj;
        });
}

// ============================================================
// PROFICIENCY LEVEL from iReady placement
// Level 4 = Grade 9+ or "Mid or Above" at grade
// Level 3 = On grade level (Early On Grade Level)
// Level 2 = 1 Grade Level Below
// Level 1 = 2+ Grade Levels Below
// We use "Proficiency if Student Shows No Additional Growth" directly
// ============================================================
function getProfLevel(row) {
    const proj = row["Proficiency if Student Shows No Additional Growth"] || "";
    if (proj === "Level 4") return 4;
    if (proj === "Level 3") return 3;
    if (proj === "Level 2") return 2;
    if (proj === "Level 1") return 1;

    // Fallback: derive from Overall Relative Placement
    const rel = row["Overall Relative Placement"] || "";
    if (rel === "Mid or Above Grade Level") return 3;
    if (rel === "Early On Grade Level")     return 3;
    if (rel === "1 Grade Level Below")      return 2;
    if (rel === "2 Grade Levels Below")     return 1;
    if (rel === "3 or More Grade Levels Below") return 1;
    return 0;
}

function determineBand(school) {
    const u = String(school).toUpperCase();
    if (u.includes(" ES") || u.includes(" PS")) return "Elementary";
    if (u.includes(" MS"))                       return "Middle";
    return "Other";
}

// ============================================================
// FILTER ROWS by subgroup
// ============================================================
function applySubgroupFilter(rows, subgroupVal) {
    if (!subgroupVal || subgroupVal === "ALL") return rows;
    const [type, value] = subgroupVal.split(":");
    return rows.filter(r => {
        switch(type) {
            case "SEX":  return (r["Sex"] || "").toLowerCase() === value.toLowerCase();
            case "RACE": return (r["Combined Race and Ethnicity"] || "") === value;
            case "ESS":  return (r["Special Education"] || "").toUpperCase() === "Y";
            case "ELL":  return (r["English Language Learner"] || "").toUpperCase() === "Y";
            case "ED":   return (r["Economically Disadvantaged"] || "").toUpperCase() === "Y";
            case "504":  return (r["504 Eligible"] || "").toLowerCase() === "true";
            default:     return true;
        }
    });
}

function applySchoolFilter(rows, school) {
    if (!school || school === "ALL") return rows;
    return rows.filter(r => r["School"] === school);
}

// ============================================================
// AGGREGATE student rows into a summary record
// ============================================================
function aggregateStudents(rows, label) {
    if (!rows || !rows.length) return null;
    let s = {
        School: label,
        Total: 0, ProficientCount: 0,
        Level4Count: 0, Level3Count: 0, Level2Count: 0, Level1Count: 0
    };
    rows.forEach(r => {
        const lvl = getProfLevel(r);
        if (lvl === 0) return; // skip rows with no projection
        s.Total++;
        if (lvl >= 3) s.ProficientCount++;
        if (lvl === 4) s.Level4Count++;
        else if (lvl === 3) s.Level3Count++;
        else if (lvl === 2) s.Level2Count++;
        else if (lvl === 1) s.Level1Count++;
    });
    s.ProficientPct = s.Total > 0 ? s.ProficientCount / s.Total : 0;
    return s.Total > 0 ? s : null;
}

// ============================================================
// VIEW BUILDERS
// ============================================================
function getBySchool(rows) {
    const schools = [...new Set(rows.map(r => String(r["School"] || "").trim()))].filter(Boolean).sort();
    return schools.map(s => aggregateStudents(rows.filter(r => String(r["School"]||"").trim() === s), s)).filter(Boolean);
}

function normalizeGrade(g) {
    const s = String(g).trim();
    // Google Sheets may return "1.0" for grade 1
    const n = parseFloat(s);
    if (!isNaN(n) && Number.isInteger(n)) return String(n);
    if (!isNaN(n) && s.endsWith(".0")) return String(Math.round(n));
    return s;
}

function getByGrade(rows) {
    const grades = [...new Set(rows.map(r => normalizeGrade(r["Student Grade"])))].filter(Boolean);
    const sorted = grades.sort((a, b) => {
        if (a.toUpperCase() === "K") return -1; if (b.toUpperCase() === "K") return 1;
        return parseInt(a) - parseInt(b) || a.localeCompare(b);
    });
    return sorted.map(g => aggregateStudents(
        rows.filter(r => normalizeGrade(r["Student Grade"]) === g), "Grade " + g
    )).filter(Boolean);
}

function getDistrict(rows) {
    return [aggregateStudents(rows, "District Total")].filter(Boolean);
}

function getByBand(rows) {
    return ["Elementary", "Middle", "Other"].map(band => {
        const bandRows = rows.filter(r => determineBand(r["School"]) === band);
        return aggregateStudents(bandRows, band + " Schools");
    }).filter(x => x && x.Total > 0);
}

function getSchoolByGrade(rows, school) {
    const filtered = school === "ALL" ? rows : rows.filter(r => r["School"] === school);
    return getByGrade(filtered);
}

// All subgroups side by side
function getAllSubgroups(rows) {
    const subgroups = [
        ["All Students",              rows],
        ["Male",                      rows.filter(r => (r["Sex"]||"").toLowerCase() === "male")],
        ["Female",                    rows.filter(r => (r["Sex"]||"").toLowerCase() === "female")],
        ["White",                     rows.filter(r => r["Combined Race and Ethnicity"] === "White (non-Hispanic)")],
        ["Black or African American", rows.filter(r => r["Combined Race and Ethnicity"] === "Black or African American (non-Hispanic)")],
        ["Hispanic or Latino",        rows.filter(r => r["Combined Race and Ethnicity"] === "Hispanic or Latino (of any race)")],
        ["Asian",                     rows.filter(r => r["Combined Race and Ethnicity"] === "Asian")],
        ["Two or More Races",         rows.filter(r => r["Combined Race and Ethnicity"] === "Two or more Races")],
        ["ESS",                       rows.filter(r => (r["Special Education"]||"").toUpperCase() === "Y")],
        ["ELL",                       rows.filter(r => (r["English Language Learner"]||"").toUpperCase() === "Y")],
        ["Econ. Disadvantaged",       rows.filter(r => (r["Economically Disadvantaged"]||"").toUpperCase() === "Y")],
        ["504",                       rows.filter(r => (r["504 Eligible"]||"").toLowerCase() === "true")],
    ];
    return subgroups.map(([label, srows]) => aggregateStudents(srows, label)).filter(Boolean);
}

// ============================================================
// POPULATE SCHOOL DROPDOWN
// ============================================================
function populateSchoolFilter(rows) {
    const select = document.getElementById("schoolFilter");
    const current = select.value;
    const schools = [...new Set(rows.map(r => r["School"]))].filter(Boolean).sort();
    select.innerHTML = `<option value="ALL">All Schools</option>`;
    schools.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s; opt.textContent = s;
        if (s === current) opt.selected = true;
        select.appendChild(opt);
    });
}

// ============================================================
// LOAD DATA
// ============================================================
async function loadAllData() {
    if (SHEET_ID === "1ctBefvTlb4YtisW2a2NB7HHy6_m20d54Y2HPe9YayWY") {
        document.getElementById("setupBanner").style.display = "block";
        document.getElementById("loadingScreen").style.display = "none";
        return;
    }

    document.getElementById("setupBanner").style.display = "none";
    document.getElementById("loadingScreen").style.display = "flex";
    document.getElementById("dashboardUI").style.display = "none";

    try {
        for (const [subj, term, tabName] of TABS) {
            document.getElementById("loadingMsg").textContent = `Loading ${tabName}...`;
            try {
                const rows = await fetchSheetTab(tabName);
                rawStore[subj][term] = rows.filter(r => r["School"] && r["Student Grade"]);
                console.log(`${tabName}: ${rawStore[subj][term].length} students loaded`);
            } catch(e) {
                console.warn(`Could not load "${tabName}":`, e.message);
            }
        }

        document.getElementById("lastUpdated").textContent =
            "Last loaded: " + new Date().toLocaleString();
        document.getElementById("loadingScreen").style.display = "none";
        document.getElementById("dashboardUI").style.display = "block";
        renderDashboard();

    } catch(err) {
        document.getElementById("loadingMsg").textContent =
            "‚ùå Error: " + err.message + ". Check your Sheet ID and make sure the Sheet is public.";
    }
}

// ============================================================
// TABS
// ============================================================
function selectSubject(s) { currentSubject = s; updateActiveTabs("subjectTabs", s); renderDashboard(); }
function selectTerm(t)    { currentTerm    = t; updateActiveTabs("termTabs",    t); renderDashboard(); }
function selectView(v)    { currentView    = v; updateActiveTabs("viewTabs",    v); renderDashboard(); }

function updateActiveTabs(id, active) {
    document.getElementById(id).querySelectorAll(".tab").forEach(tab => {
        const onclick = tab.getAttribute("onclick") || "";
        tab.classList.toggle("active",
            onclick.includes("'" + active + "'") || onclick.includes('"' + active + '"'));
    });
}

// ============================================================
// CHARTS
// ============================================================
let chart1, chart2, chart3;
function destroyCharts() {
    [chart1, chart2, chart3].forEach(c => { if (c) c.destroy(); });
    chart1 = chart2 = chart3 = null;
}

// ============================================================
// MAIN RENDER
// ============================================================
function renderDashboard() {
    const container = document.getElementById("dashboardContent");
    container.innerHTML = "";
    destroyCharts();

    let rows = rawStore[currentSubject][currentTerm];

    if (!rows || !rows.length) {
        container.innerHTML = `<div class="empty-state">No data for <strong>${currentSubject} ‚Äì ${currentTerm}</strong>.<br>Make sure the <strong>${currentSubject} ${currentTerm}</strong> tab exists in your Google Sheet.</div>`;
        return;
    }

    // Populate school dropdown
    populateSchoolFilter(rows);

    // Apply subgroup + school filters
    const subgroupVal = document.getElementById("subgroupFilter").value;
    const schoolVal   = document.getElementById("schoolFilter").value;
    rows = applySubgroupFilter(rows, subgroupVal);
    rows = applySchoolFilter(rows, schoolVal);

    // Subgroup label for display
    const subgroupLabel = document.getElementById("subgroupFilter").selectedOptions[0].text;
    const schoolLabel   = schoolVal === "ALL" ? "" : ` ‚Äî ${schoolVal}`;

    let records, rowLabel, titleSuffix;

    switch(currentView) {
        case "School":
            records     = getBySchool(rows);
            rowLabel    = "School";
            titleSuffix = "by School";
            break;
        case "Grade":
            records     = getByGrade(rows);
            rowLabel    = "Grade";
            titleSuffix = "by Grade";
            break;
        case "District":
            records     = getDistrict(rows);
            rowLabel    = "District";
            titleSuffix = "District Total";
            break;
        case "Bands":
            records     = getByBand(rows);
            rowLabel    = "Band";
            titleSuffix = "by Grade Band";
            break;
        case "SchoolGrade":
            records     = getSchoolByGrade(rows, schoolVal);
            rowLabel    = "Grade";
            titleSuffix = schoolVal === "ALL" ? "by School" : `${schoolVal} by Grade`;
            break;
        case "Subgroups":
            records     = getAllSubgroups(rows);
            rowLabel    = "Subgroup";
            titleSuffix = "All Subgroups Comparison";
            break;
        default:
            records = getBySchool(rows);
            rowLabel = "School";
            titleSuffix = "by School";
    }

    if (!records || !records.length) {
        container.innerHTML = `<div class="empty-state">No data for this filter combination.</div>`;
        return;
    }

    const title = `${currentSubject} ‚Äì ${currentTerm}${schoolLabel} | ${titleSuffix}`;
    const subTag = subgroupVal !== "ALL" ? `<span class="subgroup-tag">${subgroupLabel}</span>` : "";

    container.appendChild(buildMetricCards(records, subTag));
    container.appendChild(buildBarChart("chart1", records, title));
    container.appendChild(buildStackedChart("chart2", records, `Level Distribution ${titleSuffix}`));
    container.appendChild(buildTable(records, rowLabel));

    // Growth chart (district level, respects subgroup filter)
    if (currentView !== "Subgroups") {
        const growth = buildGrowthSection(subgroupVal, schoolVal);
        if (growth) container.appendChild(growth);
    }
}

// ============================================================
// KPI CARDS
// ============================================================
function buildMetricCards(records, subTag = "") {
    const total = records.reduce((s, r) => s + r.Total, 0);
    const prof  = records.reduce((s, r) => s + r.ProficientCount, 0);
    const pct   = total > 0 ? (prof / total * 100).toFixed(1) : 0;
    const w = document.createElement("div");
    w.className = "card-container";
    w.innerHTML = `
        <div class="card"><h3>Total Students ${subTag}</h3><div class="big-num">${total.toLocaleString()}</div></div>
        <div class="card"><h3># Proficient (Levels 3 + 4)</h3><div class="big-num">${prof.toLocaleString()}</div></div>
        <div class="card"><h3>% Proficient</h3><div class="big-num">${pct}%</div></div>`;
    return w;
}

// ============================================================
// BAR CHART
// ============================================================
function buildBarChart(canvasId, records, title) {
    const box = document.createElement("div");
    box.className = "chart-box";
    box.innerHTML = `<h3>${title}</h3><canvas id="${canvasId}"></canvas>`;
    setTimeout(() => {
        const data   = records.map(r => parseFloat((r.ProficientPct * 100).toFixed(1)));
        const colors = data.map(v => v >= 60 ? "#33cc66" : v >= 40 ? "#ffcc00" : "#ff6b6b");
        chart1 = new Chart(document.getElementById(canvasId), {
            type: "bar",
            data: { labels: records.map(r => r.School), datasets: [{ label: "% Proficient", data, backgroundColor: colors }] },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, max: 100, ticks: { color: "#fff", callback: v => v + "%" } },
                    x: { ticks: { color: "#fff" } }
                }
            }
        });
    });
    return box;
}

// ============================================================
// STACKED CHART
// ============================================================
function buildStackedChart(canvasId, records, title) {
    const box = document.createElement("div");
    box.className = "chart-box";
    box.innerHTML = `<h3>${title}</h3><canvas id="${canvasId}"></canvas>`;
    setTimeout(() => {
        chart2 = new Chart(document.getElementById(canvasId), {
            type: "bar",
            data: {
                labels: records.map(r => r.School),
                datasets: [
                    { label: "Level 4", data: records.map(r => r.Level4Count), backgroundColor: "#1f77ff" },
                    { label: "Level 3", data: records.map(r => r.Level3Count), backgroundColor: "#33cc66" },
                    { label: "Level 2", data: records.map(r => r.Level2Count), backgroundColor: "#ffcc00" },
                    { label: "Level 1", data: records.map(r => r.Level1Count), backgroundColor: "#ff6b6b" }
                ]
            },
            options: {
                plugins: { legend: { labels: { color: "#fff" } } },
                responsive: true,
                scales: {
                    x: { stacked: true, ticks: { color: "#fff" } },
                    y: { stacked: true, ticks: { color: "#fff" } }
                }
            }
        });
    });
    return box;
}

// ============================================================
// TABLE
// ============================================================
function buildTable(records, rowLabel) {
    const wrapper = document.createElement("div");
    wrapper.className = "chart-box";
    let html = `<h3>Data Table</h3>
        <table><thead><tr>
            <th>${rowLabel}</th><th>Total</th><th># Proficient</th>
            <th>% Proficient</th><th>Level 4</th><th>Level 3</th><th>Level 2</th><th>Level 1</th>
        </tr></thead><tbody>`;
    records.forEach(r => {
        const pct = (r.ProficientPct * 100).toFixed(1);
        const w   = Math.min(100, Math.max(0, parseFloat(pct)));
        html += `<tr>
            <td>${r.School}</td>
            <td>${r.Total.toLocaleString()}</td>
            <td>${r.ProficientCount.toLocaleString()}</td>
            <td><div class="pct-bar-wrap">
                <div class="pct-bar-bg"><div class="pct-bar-fill" style="width:${w}%"></div></div>
                <span>${pct}%</span>
            </div></td>
            <td>${r.Level4Count.toLocaleString()}</td>
            <td>${r.Level3Count.toLocaleString()}</td>
            <td>${r.Level2Count.toLocaleString()}</td>
            <td>${r.Level1Count.toLocaleString()}</td>
        </tr>`;
    });
    html += `</tbody></table>`;
    wrapper.innerHTML = html;
    return wrapper;
}

// ============================================================
// GROWTH CHART
// ============================================================
function buildGrowthSection(subgroupVal, schoolVal) {
    const terms     = ["Fall", "Winter"];
    const available = terms.filter(t => rawStore[currentSubject][t].length > 0);
    if (available.length < 2) return null;

    const wrapper = document.createElement("div");
    wrapper.className = "chart-box";
    wrapper.innerHTML = `<h3>Proficiency Growth: Fall ‚Üí Winter</h3><canvas id="chart3"></canvas>`;

    const labels = [], values = [];
    available.forEach(term => {
        let recs = rawStore[currentSubject][term];
        recs = applySubgroupFilter(recs, subgroupVal);
        recs = applySchoolFilter(recs, schoolVal);
        const agg = aggregateStudents(recs, term);
        labels.push(term);
        values.push(agg ? parseFloat((agg.ProficientPct * 100).toFixed(1)) : 0);
    });

    setTimeout(() => {
        chart3 = new Chart(document.getElementById("chart3"), {
            type: "line",
            data: {
                labels,
                datasets: [{
                    label: "% Proficient", data: values,
                    borderColor: "#4c8bf5", backgroundColor: "rgba(76,139,245,0.15)",
                    fill: true, tension: 0.3, pointRadius: 8, pointBackgroundColor: "#4c8bf5"
                }]
            },
            options: {
                plugins: { legend: { labels: { color: "#fff" } } },
                scales: {
                    y: { beginAtZero: true, max: 100, ticks: { color: "#fff", callback: v => v + "%" } },
                    x: { ticks: { color: "#fff" } }
                }
            }
        });
    });
    return wrapper;
}

// ============================================================
// START
// ============================================================
loadAllData();
</script>
</body>
</html>
